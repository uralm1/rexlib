--- ipsec.orig	2020-04-29 20:01:41.776182086 +0500
+++ ipsec.init	2020-05-22 22:30:24.708538941 +0500
@@ -141,6 +141,8 @@
 	local inactivity
 	local keyexchange
 	local reqid
+        local compress
+	local left
 
 	config_get mode                     "$1"           mode "route"
 	config_get local_subnet             "$1"           local_subnet ""
@@ -161,11 +163,13 @@
 	config_get inactivity               "$1"           inactivity
 	config_get keyexchange              "$1"           keyexchange "ikev2"
 	config_get reqid                    "$1"           reqid
+	config_get_bool compress            "$1"           compress 0
 
 	[ -n "$local_nat" ] && local_subnet=$local_nat
+	[ -n "$local_gateway" ] && left=$local_gateway || left="%any"
 
 	ipsec_xappend "conn $config_name-$1"
-	ipsec_xappend "  left=%any"
+	ipsec_xappend "  left=$left"
 	ipsec_xappend "  right=$remote_gateway"
 
 	[ -n "$local_sourceip" ] && ipsec_xappend "  leftsourceip=$local_sourceip"
@@ -180,6 +184,7 @@
 	ipsec_xappend "  keyingtries=$keyingtries"
 	ipsec_xappend "  dpdaction=$dpdaction"
 	ipsec_xappend "  dpddelay=$dpddelay"
+	[ $compress -eq 1 ] && ipsec_xappend "  compress=yes"
 
 	[ -n "$inactivity" ] && ipsec_xappend "  inactivity=$inactivity"
 	[ -n "$reqid" ] && ipsec_xappend "  reqid=$reqid"
@@ -224,6 +229,7 @@
 config_remote() {
 	local enabled
 	local gateway
+	local local_gateway_sec
 	local pre_shared_key
 	local auth_method
 
@@ -233,6 +239,7 @@
 	[ $enabled -eq 0 ] && return
 
 	config_get gateway           "$1" gateway
+	config_get local_gateway     "$1" local_gateway ""
 	config_get pre_shared_key    "$1" pre_shared_key
 	config_get auth_method       "$1" authentication_method
 	config_get local_identifier  "$1" local_identifier ""
@@ -244,10 +251,10 @@
 		local ipdest
 
 		[ "$remote_gateway" = "%any" ] && ipdest="1.1.1.1" || ipdest="$remote_gateway"
-		local_gateway=`ip route get $ipdest | awk -F"src" '/src/{gsub(/ /,"");print $2}'`
+		[ -n "$local_gateway" ] && local_gateway_sec="$local_gateway" || local_gateway_sec=$(ip route get $ipdest | sed 's/^.*src \([^ ]*\).*$/\1/;q')
 	}
 
-	[ -n "$local_identifier" ] && secret_xappend -n "$local_identifier " || secret_xappend -n "$local_gateway "
+	[ -n "$local_identifier" ] && secret_xappend -n "$local_identifier " || secret_xappend -n "$local_gateway_sec "
 	[ -n "$remote_identifier" ] && secret_xappend -n "$remote_identifier " || secret_xappend -n "$remote_gateway "
 
 	secret_xappend ": PSK \"$pre_shared_key\""
@@ -264,26 +271,34 @@
 
 config_ipsec() {
 	local debug
-	local rtinstall_enabled
+	local install_routes_enabled
 	local routing_tables_ignored
 	local routing_table
 	local routing_table_id
 	local interface
 	local device_list
+        local routing_table_code
+        local routing_table_prio
+	local install_virtual_ip_enabled
 
 	ipsec_reset
 	secret_reset
 	swan_reset
 
 	ipsec_xappend "# generated by /etc/init.d/ipsec"
-	ipsec_xappend "version 2"
+	#ipsec_xappend "version 2"
 	ipsec_xappend ""
 
 	secret_xappend "# generated by /etc/init.d/ipsec"
 
 	config_get debug "$1" debug 0
-	config_get_bool rtinstall_enabled "$1" rtinstall_enabled 1
-	[ $rtinstall_enabled -eq 1 ] && install_routes=yes || install_routes=no
+	config_get_bool install_routes_enabled "$1" install_routes 1
+	[ $install_routes_enabled -eq 1 ] && install_routes=yes || install_routes=no
+	config_get_bool install_virtual_ip_enabled "$1" install_virtual_ip 1
+	[ $install_virtual_ip_enabled -eq 1 ] && install_virtual_ip=yes || install_virtual_ip=no
+
+	config_get routing_table_code "$1" routing_table 220
+	config_get routing_table_prio "$1" routing_table_prio 220
 
 	# prepare extra charon config option ignore_routing_tables
 	for routing_table in $(config_get "$1" "ignore_routing_tables"); do
@@ -311,6 +326,9 @@
 	swan_xappend "charon {"
 	swan_xappend "  load_modular = yes"
 	swan_xappend "  install_routes = $install_routes"
+	swan_xappend "  install_virtual_ip = $install_virtual_ip"
+	swan_xappend "  routing_table = $routing_table_code"
+	swan_xappend "  routing_table_prio = $routing_table_prio"
 	[ -n "$routing_tables_ignored" ] && swan_xappend "  ignore_routing_tables = $routing_tables_ignored"
 	[ -n "$device_list" ] && swan_xappend "  interfaces_use = $device_list"
 	swan_xappend "    plugins {"
@@ -321,9 +339,9 @@
 	swan_xappend "    daemon {"
 	swan_xappend "      default = $debug"
 	swan_xappend "    }"
-	swan_xappend "    auth {"
-	swan_xappend "      default = $debug"
-	swan_xappend "    }"
+	#swan_xappend "    auth {"
+	#swan_xappend "      default = $debug"
+	#swan_xappend "    }"
 	swan_xappend "  }"
 	swan_xappend "}"
 }
@@ -363,7 +381,7 @@
 
 service_triggers() {
 	procd_add_reload_trigger "ipsec"
-	config load "ipsec"
+	config_load ipsec
 	config_foreach check_ipsec_interface ipsec
 }
 

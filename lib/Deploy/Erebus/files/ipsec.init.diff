--- ipsec.orig	2020-04-29 20:01:41.776182086 +0500
+++ ipsec.init	2020-04-30 17:42:00.163708430 +0500
@@ -141,6 +141,7 @@
 	local inactivity
 	local keyexchange
 	local reqid
+        local compress
 
 	config_get mode                     "$1"           mode "route"
 	config_get local_subnet             "$1"           local_subnet ""
@@ -161,6 +162,7 @@
 	config_get inactivity               "$1"           inactivity
 	config_get keyexchange              "$1"           keyexchange "ikev2"
 	config_get reqid                    "$1"           reqid
+	config_get_bool compress            "$1"           compress 0
 
 	[ -n "$local_nat" ] && local_subnet=$local_nat
 
@@ -180,6 +182,7 @@
 	ipsec_xappend "  keyingtries=$keyingtries"
 	ipsec_xappend "  dpdaction=$dpdaction"
 	ipsec_xappend "  dpddelay=$dpddelay"
+	[ $compress -eq 1 ] && ipsec_xappend "  compress=yes"
 
 	[ -n "$inactivity" ] && ipsec_xappend "  inactivity=$inactivity"
 	[ -n "$reqid" ] && ipsec_xappend "  reqid=$reqid"
@@ -244,7 +247,7 @@
 		local ipdest
 
 		[ "$remote_gateway" = "%any" ] && ipdest="1.1.1.1" || ipdest="$remote_gateway"
-		local_gateway=`ip route get $ipdest | awk -F"src" '/src/{gsub(/ /,"");print $2}'`
+		local_gateway=$(ip route get $ipdest | sed 's/^.*src \([^ ]*\).*$/\1/;q')
 	}
 
 	[ -n "$local_identifier" ] && secret_xappend -n "$local_identifier " || secret_xappend -n "$local_gateway "
@@ -264,26 +267,31 @@
 
 config_ipsec() {
 	local debug
-	local rtinstall_enabled
+	local install_routes_enabled
 	local routing_tables_ignored
 	local routing_table
 	local routing_table_id
 	local interface
 	local device_list
+        local routing_table_code
+        local routing_table_prio
 
 	ipsec_reset
 	secret_reset
 	swan_reset
 
 	ipsec_xappend "# generated by /etc/init.d/ipsec"
-	ipsec_xappend "version 2"
+	#ipsec_xappend "version 2"
 	ipsec_xappend ""
 
 	secret_xappend "# generated by /etc/init.d/ipsec"
 
 	config_get debug "$1" debug 0
-	config_get_bool rtinstall_enabled "$1" rtinstall_enabled 1
-	[ $rtinstall_enabled -eq 1 ] && install_routes=yes || install_routes=no
+	config_get_bool install_routes_enabled "$1" install_routes 1
+	[ $install_routes_enabled -eq 1 ] && install_routes=yes || install_routes=no
+
+	config_get routing_table_code "$1" routing_table 220
+	config_get routing_table_prio "$1" routing_table_prio 220
 
 	# prepare extra charon config option ignore_routing_tables
 	for routing_table in $(config_get "$1" "ignore_routing_tables"); do
@@ -311,6 +319,8 @@
 	swan_xappend "charon {"
 	swan_xappend "  load_modular = yes"
 	swan_xappend "  install_routes = $install_routes"
+	swan_xappend "  routing_table = $routing_table_code"
+	swan_xappend "  routing_table_prio = $routing_table_prio"
 	[ -n "$routing_tables_ignored" ] && swan_xappend "  ignore_routing_tables = $routing_tables_ignored"
 	[ -n "$device_list" ] && swan_xappend "  interfaces_use = $device_list"
 	swan_xappend "    plugins {"
@@ -321,9 +331,9 @@
 	swan_xappend "    daemon {"
 	swan_xappend "      default = $debug"
 	swan_xappend "    }"
-	swan_xappend "    auth {"
-	swan_xappend "      default = $debug"
-	swan_xappend "    }"
+	#swan_xappend "    auth {"
+	#swan_xappend "      default = $debug"
+	#swan_xappend "    }"
 	swan_xappend "  }"
 	swan_xappend "}"
 }
@@ -363,7 +373,7 @@
 
 service_triggers() {
 	procd_add_reload_trigger "ipsec"
-	config load "ipsec"
+	config_load ipsec
 	config_foreach check_ipsec_interface ipsec
 }
 
